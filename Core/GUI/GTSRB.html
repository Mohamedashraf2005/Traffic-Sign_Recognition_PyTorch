<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GTSRB - German Traffic Sign Recognition</title>
  <style>
    /* ========== CSS RESET & BASE ========== */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #f5f7fa;
      color: #1a1a2e;
      min-height: 100vh;
      line-height: 1.6;
    }

    /* ========== HEADER ========== */
    header {
      background: #1a1a2e;
      color: #fff;
      padding: 1.5rem 2rem;
      text-align: center;
    }

    header h1 {
      font-size: 1.75rem;
      font-weight: 700;
      letter-spacing: 0.05em;
    }

    header p {
      font-size: 0.95rem;
      color: #a0aec0;
      margin-top: 0.25rem;
    }

    /* ========== MAIN LAYOUT ========== */
    main {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 1rem;
      display: grid;
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }

    @media (min-width: 768px) {
      main {
        grid-template-columns: 1fr 320px;
      }
    }

    /* ========== CARDS ========== */
    .card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      padding: 1.5rem;
    }

    .card h2 {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: #1a1a2e;
    }

    /* ========== DROP ZONE ========== */
    .drop-zone {
      border: 2px dashed #cbd5e0;
      border-radius: 8px;
      padding: 2rem;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
    }

    .drop-zone:hover,
    .drop-zone.dragover {
      border-color: #4a6cf7;
      background: #f0f4ff;
    }

    .drop-zone p {
      color: #64748b;
      margin-bottom: 0.75rem;
    }

    .drop-zone input[type="file"] {
      display: none;
    }

    .drop-zone label {
      display: inline-block;
      background: #4a6cf7;
      color: #fff;
      padding: 0.5rem 1.25rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.2s;
    }

    .drop-zone label:hover {
      background: #3b5de7;
    }

    /* ========== PREVIEW AREA ========== */
    .preview-area {
      margin-top: 1.5rem;
      display: none;
    }

    .preview-area.visible {
      display: block;
    }

    .preview-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.75rem;
    }

    .preview-container img {
      max-width: 100%;
      max-height: 80vh;
      border-radius: 8px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.1);
    }

    .image-dimensions {
      font-size: 0.85rem;
      color: #64748b;
      background: #f1f5f9;
      padding: 0.25rem 0.75rem;
      border-radius: 4px;
    }

    /* ========== CLASSIFY BUTTON ========== */
    .classify-btn {
      margin-top: 1rem;
      width: 100%;
      padding: 0.75rem 1.5rem;
      background: #10b981;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s, opacity 0.2s;
    }

    .classify-btn:hover:not(:disabled) {
      background: #059669;
    }

    .classify-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* ========== CLASSIFICATION PANEL ========== */
    .status-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
      margin-bottom: 1rem;
    }

    .status-idle { background: #e2e8f0; color: #64748b; }
    .status-uploading { background: #fef3c7; color: #92400e; }
    .status-classifying { background: #dbeafe; color: #1e40af; }
    .status-success { background: #d1fae5; color: #065f46; }
    .status-error { background: #fee2e2; color: #991b1b; }

    .top-prediction {
      background: #f0fdf4;
      border: 1px solid #bbf7d0;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      display: none;
    }

    .top-prediction.visible {
      display: block;
    }

    .top-prediction .label {
      font-size: 0.75rem;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .top-prediction .class-name {
      font-size: 1.1rem;
      font-weight: 600;
      color: #065f46;
      margin: 0.25rem 0;
    }

    .top-prediction .confidence {
      font-size: 1.5rem;
      font-weight: 700;
      color: #10b981;
    }

    .top-k-list {
      display: none;
    }

    .top-k-list.visible {
      display: block;
    }

    .top-k-list h3 {
      font-size: 0.85rem;
      color: #64748b;
      margin-bottom: 0.5rem;
    }

    .top-k-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0;
      border-bottom: 1px solid #f1f5f9;
    }

    .top-k-item:last-child {
      border-bottom: none;
    }

    .top-k-item .class {
      font-size: 0.9rem;
      color: #334155;
    }

    .top-k-item .conf {
      font-size: 0.85rem;
      font-weight: 600;
      color: #4a6cf7;
    }

    /* ========== ERROR MESSAGE ========== */
    .error-message {
      background: #fee2e2;
      border: 1px solid #fecaca;
      color: #991b1b;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      font-size: 0.9rem;
      display: none;
    }

    .error-message.visible {
      display: block;
    }

    /* ========== RAW JSON TOGGLE ========== */
    .json-toggle {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid #e2e8f0;
      display: none;
    }

    .json-toggle.visible {
      display: block;
    }

    .json-toggle button {
      background: none;
      border: 1px solid #cbd5e0;
      color: #64748b;
      padding: 0.4rem 0.75rem;
      border-radius: 4px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .json-toggle button:hover {
      border-color: #4a6cf7;
      color: #4a6cf7;
    }

    .json-output {
      margin-top: 0.75rem;
      background: #1a1a2e;
      color: #a5f3fc;
      padding: 1rem;
      border-radius: 6px;
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 0.75rem;
      overflow-x: auto;
      display: none;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .json-output.visible {
      display: block;
    }

    /* ========== ACCESSIBILITY ========== */
    :focus-visible {
      outline: 2px solid #4a6cf7;
      outline-offset: 2px;
    }
  </style>
</head>
<body>
  <header>
    <h1>GTSRB</h1>
    <p>A Computer Vision project for German Traffic Sign Recognition</p>
  </header>

  <main>
    <!-- Upload & Preview Section -->
    <section class="card">
      <h2>Upload Image</h2>
      
      <div class="drop-zone" id="dropZone" role="button" tabindex="0" aria-label="Drop zone for image upload">
        <p>Drag & drop an image here, or</p>
        <label for="fileInput">Browse Files</label>
        <input type="file" id="fileInput" accept=".jpg,.jpeg,.png" aria-label="Select image file">
      </div>

      <div class="preview-area" id="previewArea">
        <div class="preview-container">
          <img id="previewImage" alt="Uploaded traffic sign preview">
          <span class="image-dimensions" id="imageDimensions"></span>
        </div>
        <button class="classify-btn" id="classifyBtn" disabled>Classify</button>
      </div>
    </section>

    <!-- Classification Results Panel -->
    <aside class="card">
      <h2>Classification</h2>
      
      <span class="status-badge status-idle" id="statusBadge">Idle</span>

      <div class="error-message" id="errorMessage" role="alert"></div>

      <div class="top-prediction" id="topPrediction">
        <span class="label">Top Prediction</span>
        <p class="class-name" id="topClass"></p>
        <span class="confidence" id="topConfidence"></span>
      </div>

      <div class="top-k-list" id="topKList">
        <h3>Top 3 Predictions</h3>
        <div id="topKItems"></div>
      </div>

      <div class="json-toggle" id="jsonToggle">
        <button id="toggleJsonBtn" aria-expanded="false">Show Raw JSON</button>
        <pre class="json-output" id="jsonOutput" aria-label="Raw JSON response"></pre>
      </div>
    </aside>
  </main>

  <script>
    /**
     * ========================================
     * GTSRB Traffic Sign Classifier
     * ========================================
     * 
     * API CONFIGURATION:
     * Replace the placeholders below with your actual API endpoint and key.
     * - API_URL: The endpoint that accepts POST requests with image data
     * - API_KEY: Your API key (leave empty string if not required)
     * - The image is sent as multipart/form-data with field name "image"
     * 
     * Expected API Response (Success):
     * {
     *   "predicted_class": "Speed limit (50km/h)",
     *   "confidence": 0.92,
     *   "top_k": [
     *     {"class": "Speed limit (50km/h)", "confidence": 0.92},
     *     {"class": "Keep right", "confidence": 0.05},
     *     {"class": "No entry", "confidence": 0.03}
     *   ]
     * }
     * 
     * Expected API Response (Error):
     * { "error": "description" }
     */
    
    // ========== API PLACEHOLDERS - REPLACE THESE ==========
    const API_URL = "<<API_URL_HERE>>";
    const API_KEY = "<<API_KEY_HERE>>";
    // ======================================================

    // DOM Elements
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const previewArea = document.getElementById('previewArea');
    const previewImage = document.getElementById('previewImage');
    const imageDimensions = document.getElementById('imageDimensions');
    const classifyBtn = document.getElementById('classifyBtn');
    const statusBadge = document.getElementById('statusBadge');
    const errorMessage = document.getElementById('errorMessage');
    const topPrediction = document.getElementById('topPrediction');
    const topClass = document.getElementById('topClass');
    const topConfidence = document.getElementById('topConfidence');
    const topKList = document.getElementById('topKList');
    const topKItems = document.getElementById('topKItems');
    const jsonToggle = document.getElementById('jsonToggle');
    const toggleJsonBtn = document.getElementById('toggleJsonBtn');
    const jsonOutput = document.getElementById('jsonOutput');

    // State
    let selectedFile = null;
    let lastResponse = null;

    // Status update helper
    function setStatus(status, message) {
      statusBadge.className = 'status-badge';
      statusBadge.classList.add(`status-${status}`);
      statusBadge.textContent = message;
    }

    // Reset results
    function resetResults() {
      errorMessage.classList.remove('visible');
      topPrediction.classList.remove('visible');
      topKList.classList.remove('visible');
      jsonToggle.classList.remove('visible');
      jsonOutput.classList.remove('visible');
      toggleJsonBtn.setAttribute('aria-expanded', 'false');
      toggleJsonBtn.textContent = 'Show Raw JSON';
      lastResponse = null;
    }

    // Show error
    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.classList.add('visible');
      setStatus('error', 'Error');
    }

    // Handle file selection
    function handleFile(file) {
      if (!file) return;

      // Validate file type
      const validTypes = ['image/jpeg', 'image/jpg', 'image/png'];
      if (!validTypes.includes(file.type)) {
        showError('Please upload a valid image file (JPG, JPEG, or PNG).');
        return;
      }

      selectedFile = file;
      resetResults();
      setStatus('uploading', 'Uploading…');

      // Read and preview image
      const reader = new FileReader();
      reader.onload = function(e) {
        previewImage.src = e.target.result;
        
        // Get image dimensions once loaded
        previewImage.onload = function() {
          const width = previewImage.naturalWidth;
          const height = previewImage.naturalHeight;
          imageDimensions.textContent = `${width} × ${height} px`;
          previewArea.classList.add('visible');
          classifyBtn.disabled = false;
          setStatus('idle', 'Ready');
        };
      };
      reader.onerror = function() {
        showError('Failed to read image file.');
      };
      reader.readAsDataURL(file);
    }

    // Drag and drop handlers
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      handleFile(file);
    });

    // Click to open file dialog
    dropZone.addEventListener('click', () => {
      fileInput.click();
    });

    // Keyboard accessibility for drop zone
    dropZone.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        fileInput.click();
      }
    });

    // File input change
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      handleFile(file);
    });

    // Classify button click
    classifyBtn.addEventListener('click', async () => {
      if (!selectedFile) return;

      resetResults();
      setStatus('classifying', 'Classifying…');
      classifyBtn.disabled = true;

      try {
        // Prepare form data - field name is "image"
        const formData = new FormData();
        formData.append('image', selectedFile);

        // Prepare headers
        const headers = {};
        if (API_KEY && API_KEY !== '<<API_KEY_HERE>>') {
          headers['Authorization'] = `Bearer ${API_KEY}`;
        }

        // Send request
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: headers,
          body: formData
        });

        // Parse response
        const data = await response.json();
        lastResponse = data;

        // Check for error response
        if (!response.ok || data.error) {
          throw new Error(data.error || `Server error: ${response.status}`);
        }

        // Display results
        setStatus('success', 'Complete');

        // Top prediction
        topClass.textContent = data.predicted_class;
        topConfidence.textContent = `${(data.confidence * 100).toFixed(1)}%`;
        topPrediction.classList.add('visible');

        // Top-K list
        if (data.top_k && data.top_k.length > 0) {
          topKItems.innerHTML = '';
          data.top_k.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'top-k-item';
            div.innerHTML = `
              <span class="class">${index + 1}. ${item.class}</span>
              <span class="conf">${(item.confidence * 100).toFixed(1)}%</span>
            `;
            topKItems.appendChild(div);
          });
          topKList.classList.add('visible');
        }

        // Show JSON toggle
        jsonToggle.classList.add('visible');
        jsonOutput.textContent = JSON.stringify(data, null, 2);

      } catch (error) {
        // Handle different error types
        if (error.name === 'TypeError' && error.message.includes('fetch')) {
          showError('Network error. Please check your connection and API URL.');
        } else if (error.message.includes('CORS')) {
          showError('CORS error. The API server may not allow requests from this origin.');
        } else {
          showError(error.message || 'An unexpected error occurred.');
        }

        // Still show raw response if available
        if (lastResponse) {
          jsonToggle.classList.add('visible');
          jsonOutput.textContent = JSON.stringify(lastResponse, null, 2);
        }
      } finally {
        classifyBtn.disabled = false;
      }
    });

    // Toggle raw JSON display
    toggleJsonBtn.addEventListener('click', () => {
      const isVisible = jsonOutput.classList.toggle('visible');
      toggleJsonBtn.textContent = isVisible ? 'Hide Raw JSON' : 'Show Raw JSON';
      toggleJsonBtn.setAttribute('aria-expanded', isVisible);
    });
  </script>
</body>
</html>
